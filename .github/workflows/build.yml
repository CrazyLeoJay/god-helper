name: flutter build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  apk-build:
    runs-on: ubuntu-latest
    environment:
      name: build
    steps:
      - shell: bash
        run: echo $BUILD_TEST_ARG
        env:
          BUILD_TEST_ARG: ${{ vars.BUILD_TEST_ARG }}
      - name: Create keystore
        shell: bash
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > keystore.jks
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_FILE: keystore.jks

      - name: Clone repository
        uses: actions/checkout@v4.2.2

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        # with:
        #   flutter-version: '3.24.3'
        with:
          channel: stable
          flutter-version-file: pubspec.yaml
      - run: flutter --version
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'oracle'
          cache: gradle

      - run: flutter pub get

      - name: Build APK with signing
        run: export KEYSTORE_FILE=$KEYSTORE_FILE && \
          export JKS_PASSWORD=$JKS_PASSWORD && \
          export KEYSTORE_ALIAS=$KEYSTORE_ALIAS && \
          flutter build apk --release --flavor github_actions
        env:
          JKS_PASSWORD: ${{ secrets.JKS_PASSWORD }}
          KEYSTORE_FILE: "keystore.jks"
          KEYSTORE_ALIAS: "god-helper-key"

      # - run: flutter build apk
      #   name: Build APK with signing

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: release.apk
          path: build/app/outputs/flutter-apk/app-release.apk
          compression-level: 0

          # ios-build:
          #   runs-on: macos-latest
          #   steps:
          #     - name: Clone repository
          #       uses: actions/checkout@v4
          #     - name: Set up Flutter
          #       uses: subosito/flutter-action@v2
          #       with:
          #         channel: stable
          #     - run: flutter pub get
          #     - name: Build iOS App
          #       run: flutter build ios --release --no-codesign
          #     # - name: Archive the build
          #     #   run: |
          #     #     cd build/ios/iphoneos
          #     #     zip -r app.ipa Payload
          #     - name: Upload artifact
          #       uses: actions/upload-artifact@v4
          #       with:
          #         name: ios-app.ipa
          #         path: build/ios/iphoneos/app.ipa
          #         compression-level: 0







        
